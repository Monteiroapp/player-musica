<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player de M√∫sica PWA</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1e1e2f, #2c3e50);
    color: #fff;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  h1 {
    margin-bottom: 20px;
    font-size: 1.8em;
  }
  .player {
    background: #2a2a3d;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0px 5px 15px rgba(0,0,0,0.5);
    max-width: 420px;
    margin: auto;
    box-sizing: border-box;
    width: 100%;
  }
  .cover {
    width: 100%;
    max-width: 300px;
    height: auto;
    border-radius: 15px;
    margin: 15px auto;
    object-fit: cover;
    box-shadow: 0px 5px 15px rgba(0,0,0,0.5);
  }
  audio {
    display: none;
  }
  .controls {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }
  button {
    background: #ff9800;
    border: none;
    padding: 12px 18px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1em;
    transition: 0.3s;
    flex: 1 1 100px;
    max-width: 140px;
    user-select: none;
  }
  button:hover {
    background: #e68900;
  }
  button.active {
    background: #4caf50;
    color: #fff;
  }
  ul {
    list-style: none;
    padding: 0;
    margin-top: 20px;
    max-height: 160px;
    overflow-y: auto;
    max-width: 100%;
    box-sizing: border-box;
  }
  li {
    padding: 12px 10px;
    margin: 6px 0;
    background: #3b3b5c;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    font-size: 1em;
  }
  li:hover {
    background: #505072;
  }
  li.active {
    background: #ff9800;
    color: #000;
    font-weight: bold;
  }
  input[type="file"] {
    margin-top: 15px;
    padding: 10px;
    border-radius: 8px;
    background: #fff;
    color: #000;
    width: 100%;
    box-sizing: border-box;
    font-size: 1em;
  }
  #infoMusica {
    margin-top: 10px;
    font-size: 1em;
    color: #ddd;
    min-height: 1.2em;
  }
  .progress-container {
    background: #444;
    border-radius: 10px;
    height: 12px;
    margin: 15px 0;
    cursor: pointer;
    position: relative;
    width: 100%;
    max-width: 100%;
  }
  .progress {
    background: #ff9800;
    height: 100%;
    width: 0%;
    border-radius: 10px;
    transition: width 0.2s;
  }
  .time {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-top: -4px;
  }
  .volume-control {
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #ddd;
    user-select: none;
    flex-wrap: wrap;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  .volume-control input[type="range"] {
    -webkit-appearance: none;
    width: 150px;
    height: 6px;
    background: #444;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .volume-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #ff9800;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 2px rgba(0,0,0,0.5);
    transition: background 0.3s;
    margin-top: -5px;
  }
  .volume-control input[type="range"]:hover::-webkit-slider-thumb {
    background: #e68900;
  }
  /* Firefox */
  .volume-control input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #ff9800;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 2px rgba(0,0,0,0.5);
    transition: background 0.3s;
  }
  .volume-control input[type="range"]:hover::-moz-range-thumb {
    background: #e68900;
  }
</style>

<!-- Manifest dinamico via JS -->
<script>
  const manifest = {
    name: "Player de M√∫sica",
    short_name: "Player",
    start_url: "./",
    display: "standalone",
    background_color: "#1e1e2f",
    theme_color: "#ff9800",
    icons: [
      {
        src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAMAAABS6+BFAAAABlBMVEX///8AAABVwtN+AAABVklEQVR4nO3SQQrDMAwE0Nbq/Z9Mz+I6YwGKgHJlDPpxZv7aZxOD74ceH1yT9JKBSQIAkkgAIpIAJJAACSSACG6+4MlYlAuW4yqxghIhBDXYwwiELJHLF3yWQxOqq6MaIKF1PK3DYQQoZdb6KDe0QClFwqyGGEA9MwJaWzQZRfhF4YiSvCH8vGhEMw28PY2ROxUOoWrDik6SVVHUZJsD77QGnKo82pD1lH/5EJxxLn+Xx3v+82QwGdpX+IgBJQIAkkgAIpIAJJAACSSAClLzfxcs+J2CDymEQAAAAASUVORK5CYII=",
        sizes: "512x512",
        type: "image/png"
      }
    ]
  };

  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestURL;
  document.head.appendChild(link);

  // Meta theme color dinamico
  const metaTheme = document.createElement('meta');
  metaTheme.name = "theme-color";
  metaTheme.content = manifest.theme_color;
  document.head.appendChild(metaTheme);
</script>
</head>
<body>
  <h1>üé∂ Player de M√∫sica PWA</h1>

  <div class="player">
    <img id="capaMusica" class="cover" src="https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel" alt="Capa do √Ålbum" />
    <h3 id="musicaTitulo">Nenhuma m√∫sica selecionada</h3>
    <p id="infoMusica"></p>

    <div class="progress-container" id="progressContainer">
      <div class="progress" id="progress"></div>
    </div>
    <div class="time">
      <span id="tempoAtual">0:00</span>
      <span id="tempoTotal">0:00</span>
    </div>

    <audio id="audio"></audio>

    <div class="controls">
      <button onclick="prevMusica()">‚èÆ Anterior</button>
      <button onclick="playPause()">‚èØ Play/Pause</button>
      <button onclick="nextMusica()">‚è≠ Pr√≥xima</button>
      <button id="shuffleBtn" onclick="toggleShuffle()">üîÄ Shuffle</button>
      <button id="repeatBtn" onclick="toggleRepeat()">üîÅ Repeat</button>
    </div>

    <div class="volume-control">
      <label for="volumeRange">üîä Volume</label>
      <input type="range" id="volumeRange" min="0" max="1" step="0.01" value="1" />
    </div>

    <p>Selecione m√∫sicas (MP3):</p>
    <input type="file" id="uploadMusicas" multiple accept="audio/*" />

    <ul id="listaMusicas"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
  <script>
    // Player JS
    const audio = document.getElementById("audio");
    const musicaTitulo = document.getElementById("musicaTitulo");
    const capaMusica = document.getElementById("capaMusica");
    const listaMusicas = document.getElementById("listaMusicas");
    const uploadMusicas = document.getElementById("uploadMusicas");
    const infoMusica = document.getElementById("infoMusica");
    const progressContainer = document.getElementById("progressContainer");
    const progress = document.getElementById("progress");
    const tempoAtualEl = document.getElementById("tempoAtual");
    const tempoTotalEl = document.getElementById("tempoTotal");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const volumeRange = document.getElementById("volumeRange");

    let musicas = [];
    let musicaAtual = 0;
    let shuffle = false;
    let repeat = false;

    function carregarMusica(index) {
      musicaAtual = index;
      const musica = musicas[index];
      audio.src = URL.createObjectURL(musica.file);
      musicaTitulo.textContent = musica.titulo;
      infoMusica.textContent = `${musica.artista || "Artista desconhecido"} ‚Ä¢ ${musica.album || "√Ålbum desconhecido"}`;
      capaMusica.src = musica.capa || "https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel";
      audio.play();

      // Marca a m√∫sica ativa
      const itens = listaMusicas.getElementsByTagName("li");
      for (let i = 0; i < itens.length; i++) {
        itens[i].classList.remove("active");
      }
      itens[index].classList.add("active");
    }

    function playPause() {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
    }

    function nextMusica() {
      if (musicas.length === 0) return;
      if (repeat) {
        carregarMusica(musicaAtual);
      } else if (shuffle) {
        let novaIndex;
        do {
          novaIndex = Math.floor(Math.random() * musicas.length);
        } while (novaIndex === musicaAtual && musicas.length > 1);
        carregarMusica(novaIndex);
      } else {
        musicaAtual++;
        if (musicaAtual >= musicas.length) musicaAtual = 0;
        carregarMusica(musicaAtual);
      }
    }

    function prevMusica() {
      if (musicas.length === 0) return;
      musicaAtual--;
      if (musicaAtual < 0) musicaAtual = musicas.length - 1;
      carregarMusica(musicaAtual);
    }

    function toggleShuffle() {
      shuffle = !shuffle;
      shuffleBtn.classList.toggle("active", shuffle);
    }

    function toggleRepeat() {
      repeat = !repeat;
      repeatBtn.classList.toggle("active", repeat);
    }

    audio.addEventListener("timeupdate", () => {
      if (audio.duration) {
        const progresso = (audio.currentTime / audio.duration) * 100;
        progress.style.width = `${progresso}%`;

        tempoAtualEl.textContent = formatarTempo(audio.currentTime);
        tempoTotalEl.textContent = formatarTempo(audio.duration);
      }
    });

    progressContainer.addEventListener("click", (e) => {
      const largura = progressContainer.clientWidth;
      const cliqueX = e.offsetX;
      const duracao = audio.duration;
      audio.currentTime = (cliqueX / largura) * duracao;
    });

    volumeRange.addEventListener("input", () => {
      audio.volume = volumeRange.value;
    });

    function formatarTempo(segundos) {
      const min = Math.floor(segundos / 60);
      const sec = Math.floor(segundos % 60).toString().padStart(2, "0");
      return `${min}:${sec}`;
    }

    function extrairCapa(tags) {
      if (tags.picture) {
        const { data, format } = tags.picture;
        let base64 = "";
        const bytes = new Uint8Array(data);
        for (let i = 0; i < bytes.length; i++) {
          base64 += String.fromCharCode(bytes[i]);
        }
        return `data:${format};base64,${btoa(base64)}`;
      }
      return null;
    }

    uploadMusicas.addEventListener("change", (event) => {
      const arquivos = Array.from(event.target.files);
      musicas = [];

      arquivos.forEach((file, index) => {
        const musica = {
          titulo: file.name,
          artista: null,
          album: null,
          file: file,
          capa: "https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel",
        };

        jsmediatags.read(file, {
          onSuccess: (tag) => {
            if (tag.tags.title) musica.titulo = tag.tags.title;
            if (tag.tags.artist) musica.artista = tag.tags.artist;
            if (tag.tags.album) musica.album = tag.tags.album;
            const capaExtraida = extrairCapa(tag.tags);
            if (capaExtraida) {
              musica.capa = capaExtraida;
            }
            atualizarLista();
          },
          onError: (error) => {
            atualizarLista();
          },
        });

        musicas.push(musica);
      });

      function atualizarLista() {
        listaMusicas.innerHTML = "";
        musicas.forEach((musica, i) => {
          const li = document.createElement("li");
          li.textContent = "üéµ " + musica.titulo;
          li.onclick = () => carregarMusica(i);
          listaMusicas.appendChild(li);
        });
        if (musicas.length > 0 && audio.src === "") {
          carregarMusica(0);
        }
      }
    });

    audio.addEventListener("ended", nextMusica);
  </script>

  <!-- Service Worker embutido -->
  <script>
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'player-cache-v1';
        const urlsToCache = [
          './',
          './index.html',
          './manifest.json',
          'https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js',
        ];

        self.addEventListener('install', (event) => {
          event.waitUntil(
            caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', (event) => {
          event.respondWith(
            caches.match(event.request)
            .then(response => response || fetch(event.request))
          );
        });
      `;

      // Criar Blob e registrar SW via URL criada dinamicamente
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const swURL = URL.createObjectURL(blob);

      window.addEventListener('load', () => {
        navigator.serviceWorker.register(swURL)
          .then(reg => console.log('Service Worker registrado:', reg.scope))
          .catch(err => console.log('Falha ao registrar SW:', err));
      });
    }
  </script>
</body>
</html>
